---
import { getLocale, getSwitcherData, t } from "i18n:astro";

const locale = getLocale();
const data = getSwitcherData();
const { instanceId } = Astro.props;

const languageCodeMap: Record<string, string> = {
	en: "EN",
	fr: "FR",
};

const languageOptions = data.map((option) => ({
	locale: option.locale,
	href: option.href,
	label: t(`languageSelect.${option.locale}` as any),
	code: languageCodeMap[option.locale] || option.locale.toUpperCase().slice(0, 2),
}));
---

<language-toggle>
	<div class="language-toggle" role="radiogroup" aria-label={t("language-label")} aria-describedby={`language-instructions-${instanceId}`}>
		<span id={`language-instructions-${instanceId}`} class="visually-hidden">
			{t("languageSelect.instructions")}
		</span>
		<div class="toggle-track">
			{
				languageOptions.map((option) => (
					<>
						<input type="radio" class="language-check" name="language-selector" id={`lang-${instanceId}-${option.locale}`} value={option.locale} data-href={option.href} autocomplete="off" checked={locale === option.locale} />
						<label class={`language-option${locale === option.locale ? " is-selected" : ""}`} for={`lang-${instanceId}-${option.locale}`} lang={option.locale} data-locale={option.locale}>
							<span class="language-code" aria-hidden="true">
								{option.code}
							</span>
							<span class="visually-hidden">{option.label}</span>
						</label>
					</>
				))
			}
		</div>
		<div role="status" aria-live="polite" aria-atomic="true" class="visually-hidden language-status"></div>
	</div>
</language-toggle>

<script>
	class LanguageToggle extends HTMLElement {
		private radios: HTMLInputElement[] = [];
		private statusElement: HTMLElement | null = null;

		connectedCallback() {
			this.init();
		}

		init() {
			this.radios = Array.from(this.querySelectorAll(".language-check"));
			this.statusElement = this.querySelector(".language-status");

			this.radios.forEach((radio) => {
				radio.addEventListener("keydown", (e) => {
					const keys = ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"];
					if (keys.includes(e.key)) {
						e.preventDefault();
						const i = this.radios.indexOf(radio);
						let next;
						if (["ArrowLeft", "ArrowUp"].includes(e.key)) {
							next = i > 0 ? i - 1 : this.radios.length - 1;
						} else {
							next = i < this.radios.length - 1 ? i + 1 : 0;
						}
						this.radios[next]?.focus();
					} else if (["Enter", " "].includes(e.key)) {
						e.preventDefault();
						if (!radio.checked) {
							radio.checked = true;
							radio.dispatchEvent(new Event("change", { bubbles: true }));
						}
					}
				});

				radio.addEventListener("change", () => {
					if (radio.checked) {
						const label = radio.nextElementSibling;
						const labelText = label?.querySelector(".visually-hidden")?.textContent;
						if (this.statusElement && labelText) {
							this.statusElement.textContent = `${labelText} selected`;
						}
						window.location.href = radio.dataset.href || "/";
					}
				});
			});
		}
	}

	customElements.define("language-toggle", LanguageToggle);
</script>

<style lang="less">
	.language-toggle {
		position: relative;
		display: inline-flex;
		align-items: center;
		margin-top: 7.5px;
	}

	.toggle-track {
		position: relative;
		display: flex;
		background: var(--backgroundDark);
		border: 1px solid var(--border);
		padding: 2px;
		min-width: 80px;
		height: 32px;
		transition: all 0.3s;

		&:focus-within {
			outline: 2px solid var(--primary);
			outline-offset: 2px;
		}
	}

	.toggle-slider {
		position: absolute;
		top: 2px;
		left: 0;
		height: calc(100% - 4px);
		background: var(--primary);
		transition: all 0.3s;
		z-index: 1;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		pointer-events: none;
	}

	// Hide the radio input completely (Bootstrap btn-check pattern)
	.language-check {
		position: absolute;
		clip: rect(0, 0, 0, 0);
		pointer-events: none;

		&:focus + .language-option {
			outline: 2px solid var(--secondary);
		}

		&:focus:not(:focus-visible) + .language-option {
			outline: none;
		}
	}

	.language-option {
		display: flex;
		align-items: center;
		justify-content: center;
		// z-index: 2;
		flex: 1;
		height: 2rem;
		min-width: 2rem;
		cursor: pointer;
		// user-select: none;
		border: 2px solid transparent;
		color: var(--bodyTextColor);
		font-weight: 500;
		transition: all 0.3s;

		&:hover {
			border-color: var(--primary);
			opacity: 0.8;
		}

		.language-code {
			font-weight: 500;
		}

		// Selected state (applied via JS)
		&.is-selected {
			color: var(--light);
			background-color: var(--primary);
			font-weight: 600;

			.language-code {
				font-weight: 600;
			}
		}
	}

	.language-code {
		font-size: 0.875rem;
		letter-spacing: 0.025em;
		transition: all 0.3s;
		line-height: 1;
		display: block;
	}

	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}

	/* Dark mode styles */
	body.dark-mode {
		.toggle-track {
			background: var(--medium);
			border-color: var(--grey);

			&:hover {
				border-color: var(--primaryLight);
			}
		}

		.toggle-slider {
			background: var(--primaryLight);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
		}

		.language-option {
			color: var(--light);
			opacity: 0.7;

			&:hover {
				opacity: 0.9;
			}

			&.is-selected {
				color: var(--light);
				opacity: 1;
			}
		}
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.language-option {
			min-width: 32px;
			height: 26px;
		}

		.language-code {
			font-size: 0.8rem;
		}

		.toggle-track {
			min-width: 72px;
			height: 30px;
		}
	}
</style>
